<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mapperInterface.ChatMessageMapper">

  <select id="selectMaxSeq" resultType="int">
    SELECT IFNULL(MAX(seq),0) FROM qna WHERE qna_no = #{qna_no}
  </select>

  <insert id="insertMessage">
    INSERT INTO qna
      (qna_no, seq, qna_class, qna_type, cust_id, content, qna_dtm)
    VALUES
      (#{qna_no}, #{seq}, #{qna_class}, #{qna_type}, #{cust_id}, #{content}, #{qna_dtm})
  </insert>

  <select id="getMessagesByRoomId"
          parameterType="int"
          resultType="com.example.demo.model.ChatMessageDTO">
    SELECT q.*, c.grade
    FROM qna q
    JOIN custom c ON q.cust_id = c.cust_id
    WHERE q.qna_no = #{qna_no}
    ORDER BY q.seq
  </select>

	<!-- 가장 최근 “고객 메시지”만 가져오기 -->
	<select id="getRoomSummaries"
	        resultType="com.example.demo.model.ChatMessageDTO">
	  WITH latest_msg AS (
	      SELECT qna_no, MAX(seq) AS seq
	      FROM qna
	      WHERE cust_id != 'test'    <!-- test 제외 -->
	        AND qna_type != 2        <!-- 종료 제외 -->
	      GROUP BY qna_no
	  )
	  SELECT q.*
	  FROM qna q
	  JOIN latest_msg l
	    ON q.qna_no = l.qna_no
	   AND q.seq    = l.seq
	  ORDER BY q.qna_no DESC
	</select>


  <select id="selectNextQnaNo" resultType="int">
    SELECT IFNULL(MAX(qna_no),0) + 1 FROM qna
  </select>

  <update id="updateRoomType">
    UPDATE qna SET qna_type = #{qna_type} WHERE qna_no = #{qna_no}
  </update>
</mapper>
